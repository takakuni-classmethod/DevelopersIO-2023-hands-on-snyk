# SSTI 脆弱性の修正

続いて **Improper Neutralization of Directives in Statically Saved Code** と検出された脆弱性について対応します。

<img src="/static/images/module4/05-01-fix-ssti-vulnerability.png" width=100%>

コードでは HTML レスポンスのレンダリングに **[render_template_string](https://flask.palletsprojects.com/en/2.0.x/templating/)** を使用しています。 render_template_string は文字列から直接テンプレートをレンダリングします。これは、文字列が有効な Python コードを含むように変更された場合に、潜在的なサーバーサイドテンプレートインジェクション (SSTI) の脆弱性を引き起こす可能性があります。

1\. 潜在的な SSTI 攻撃を防ぐために、**render_template** に置き換えます。これにより、テンプレートの変更を許可しない設定に置き換わるためより安全なコードになります。これを修正するために、**pages/a1.py** のコードを次のように置き換えます。

```python
from flask import (
    Blueprint,
    request,
    render_template
)

bp = Blueprint(
    "a1", __name__,
    template_folder='templates',
    static_folder='static'
)

@bp.route("/A1")
def a1():
    name = request.args.get("name", "")
    return render_template("a1.html", name=name)
```

2\. **pages/a7.py** のコードも同様に次のように置き換えます。

```python
from flask import (
    Blueprint,
    request,
    render_template
)

bp = Blueprint(
    "a7", __name__,
    template_folder='templates',
    static_folder='static'
)

@bp.route("/A7")
def a7():
    ### Cross-Site Scripting (XSS)
    name = request.args.get("name", "")
    with open("templates/a7.html") as f:
        template = f.read()
    content = template.replace("{{ name }}", name)
    
    return render_template("a7.html", name=name)
```

[Next: オープンリダイレクト攻撃の修正](./fix-open-redirect.md)